<!DOCTYPE html>
<html lang="es">
<head>
  <title>Europa (colores por valor + tooltip)</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.11.0/dist/maplibre-gl.css" />
  <script src="https://unpkg.com/maplibre-gl@5.11.0/dist/maplibre-gl.js"></script>
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; margin: 0; }
    body { display: grid; place-items: center; padding: 24px; background: #f7f7f9; }
    .map-wrapper {
      width: min(92vw, 720px);
      aspect-ratio: 1 / 1;   /* cuadrado */
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 6px 24px rgba(0,0,0,0.12);
      background: #fff;
      position: relative;
    }
    #map { position: absolute; inset: 0; }
    .tooltip { font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", sans-serif; }
    .tooltip strong { font-weight: 600; }
    .tooltip .value { opacity: .85; }
  </style>
</head>
<body>
  <div class="map-wrapper">
    <div id="map"></div>
  </div>

  <script>
    const fixedZoom = 3.3;

    // === Valores proporcionados ===
    const VALUES = {
      "Albania": 0.84, "Azerbaijan": 1.42, "Belarus": 1.06, "Belgium": 2.35,
      "Bosnia and Herzegovina": -2.48, "Bulgaria": -0.47, "Croatia": -2.82,
      "Cyprus": -1.69, "Czechia": 0.03, "Denmark": -2.84, "Estonia": -1.81,
      "Finland": 0.90, "France": 0.27, "Germany": 0.54, "Greece": 1.86,
      "Hungary": -2.96, "Iceland": 1.83, "Ireland": 1.19, "Italy": -0.96,
      "Kosovo": -2.07, "Latvia": 2.74, "Lithuania": -2.44, "Luxembourg": -2.42,
      "Malta": 2.08, "Moldova": 0.62, "Monaco": 1.84, "Montenegro": 1.38,
      "Netherlands": 0.22, "North Macedonia": 2.84, "Norway": -0.73,
      "Poland": 0.31, "Portugal": 1.98, "Romania": 0.71, "Russia": 2.17,
      "Serbia": 1.23, "Slovakia": -2.73, "Slovenia": -1.63, "Spain": -1.26,
      "Sweden": -2.52, "Switzerland": -1.60, "Turkey": -2.39, "Ukraine": -1.33,
      "United Kingdom": 0.81
    };

    // Aliases para casar nombres del GeoJSON con tu tabla
    const NAME_ALIASES = {
      "Czech Republic": "Czechia",
      "Bosnia and Herz.": "Bosnia and Herzegovina",
      "Republic of Moldova": "Moldova",
      "The Netherlands": "Netherlands",
      "Türkiye": "Turkey",
      "Macedonia": "North Macedonia",
      "FYR Macedonia": "North Macedonia",
      "Russian Federation": "Russia",
      "UK": "United Kingdom"
    };

    function normalizeCountryName(raw) {
      return NAME_ALIASES[raw] || raw;
    }

    function formatValue(v) {
      return (typeof v === "number" && isFinite(v))
        ? (v > 0 ? `+${v.toFixed(2)}` : v.toFixed(2))
        : "—";
    }

    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://demotiles.maplibre.org/style.json',
      center: [10, 53],
      zoom: fixedZoom,
      minZoom: fixedZoom,
      maxZoom: fixedZoom
    });

    // Desactivar interacciones
    map.scrollZoom.disable();
    map.boxZoom.disable();
    map.dragPan.disable();
    map.dragRotate.disable();
    map.keyboard.disable();
    map.doubleClickZoom.disable();
    map.touchZoomRotate.disable();
    if (map.touchPitch) map.touchPitch.disable();

    // Ocultar TODAS las etiquetas (capas 'symbol') del estilo base
    function hideAllSymbolLayers() {
      const layers = (map.getStyle() && map.getStyle().layers) || [];
      layers.forEach(l => { if (l.type === 'symbol') map.setLayoutProperty(l.id, 'visibility', 'none'); });
    }
    map.on('styledata', hideAllSymbolLayers);

    let hoveredFeatureId = null;
    const popup = new maplibregl.Popup({ closeButton: false, closeOnClick: false, offset: 8 });

    map.on('load', async () => {
      hideAllSymbolLayers();

      // 1) Descarga y enriquece el GeoJSON con la propiedad "value"
      const res = await fetch('https://raw.githubusercontent.com/leakyMirror/map-of-europe/master/GeoJSON/europe.geojson');
      const geo = await res.json();

      geo.features.forEach(f => {
        const raw = f.properties.NAME || f.properties.name || f.properties.admin || f.properties.NAME_EN;
        const norm = normalizeCountryName(raw);
        const val = VALUES.hasOwnProperty(norm) ? VALUES[norm] : null;
        f.properties.name_norm = norm || raw || 'País';
        f.properties.value = (typeof val === 'number' && isFinite(val)) ? val : null;
      });

      // 2) Fuente con IDs auto-generados para usar feature-state (hover)
      map.addSource('europe', { type: 'geojson', data: geo, generateId: true });

      // 3) Relleno coloreado por valor: rojo (neg), verde (pos), gris (0/sin dato)
      map.addLayer({
        id: 'country-fills',
        type: 'fill',
        source: 'europe',
        paint: {
          'fill-color': [
            'case',
            ['all', ['has', 'value'], ['!=', ['get', 'value'], null], ['<', ['get', 'value'], 0]],
            '#e74c3c',                               // negativo -> rojo
            ['all', ['has', 'value'], ['!=', ['get', 'value'], null], ['>', ['get', 'value'], 0]],
            '#2ecc71',                               // positivo -> verde
            '#bdc3c7'                                // 0 o sin dato -> gris
          ],
          'fill-opacity': [
            'case',
            ['boolean', ['feature-state', 'hover'], false],
            1, 0.6
          ]
        }
      });

      // 4) Bordes
      map.addLayer({
        id: 'country-borders',
        type: 'line',
        source: 'europe',
        paint: { 'line-color': '#7f8c8d', 'line-width': 1.5 }
      });

      // 5) Tooltip + hover
      map.on('mousemove', 'country-fills', (e) => {
        map.getCanvas().style.cursor = 'pointer';
        if (!e.features || e.features.length === 0) return;

        const feat = e.features[0];
        if (hoveredFeatureId !== null && hoveredFeatureId !== feat.id) {
          map.setFeatureState({ source: 'europe', id: hoveredFeatureId }, { hover: false });
        }
        hoveredFeatureId = feat.id;
        map.setFeatureState({ source: 'europe', id: hoveredFeatureId }, { hover: true });

        const name = feat.properties.name_norm || 'País';
        const val = feat.properties.value;
        const html = `
          <div class="tooltip">
            <strong>${name}</strong><br/>
            <span class="value">Valor: ${formatValue(val)}</span>
          </div>
        `;
        popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
      });

      map.on('mouseleave', 'country-fills', () => {
        map.getCanvas().style.cursor = '';
        if (hoveredFeatureId !== null) {
          map.setFeatureState({ source: 'europe', id: hoveredFeatureId }, { hover: false });
        }
        hoveredFeatureId = null;
        popup.remove();
      });
    });

    // Redimensionado defensivo
    const ro = new ResizeObserver(() => map.resize());
    ro.observe(document.querySelector('.map-wrapper'));
  </script>
</body>
</html>
